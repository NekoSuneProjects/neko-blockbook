<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neko Blockbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Sora", "ui-sans-serif", "system-ui"]
            },
            colors: {
              ink: "#e6edf3",
              haze: "#0b0f14",
              pine: "#111a26",
              line: "#233246",
              mint: "#6ef2c7",
              amber: "#f5c07a",
              glow: "#7dc4ff"
            }
          }
        }
      };
    </script>
  </head>
  <body class="min-h-screen bg-haze text-ink bg-[radial-gradient(ellipse_at_top,_#1b2736_0%,_#0b0f14_55%,_#090d12_100%)]">
    <div class="border-b border-line/60 bg-pine/80 backdrop-blur">
      <div class="mx-auto flex w-full max-w-6xl items-center gap-4 px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-full bg-gradient-to-br from-mint via-glow to-amber shadow-[0_0_24px_rgba(124,196,255,0.35)]"></div>
          <div>
            <p class="text-sm uppercase tracking-[0.3em] text-ink/60">Neko</p>
            <h1 class="text-lg font-semibold">Blockbook</h1>
          </div>
        </div>
        <nav class="ml-6 hidden items-center gap-6 text-sm font-semibold text-ink/70 md:flex">
          <a href="/explorer" class="transition hover:text-mint">Status</a>
          <a href="#" class="transition hover:text-mint">Blocks</a>
          <a href="#" class="transition hover:text-mint">Txs</a>
        </nav>
        <div class="ml-auto flex flex-1 items-center gap-3">
          <div class="flex w-full items-center rounded-full border border-line/60 bg-pine/70 px-3 py-2 shadow-[0_16px_40px_-30px_rgba(0,0,0,0.9)]">
            <input
              id="search-input"
              class="w-full bg-transparent text-sm text-ink outline-none placeholder:text-ink/40"
              placeholder="Search block, transaction, address"
            />
            <button id="search-btn" class="rounded-full bg-mint px-3 py-1 text-xs font-semibold text-haze transition hover:bg-mint/90">
              Go
            </button>
          </div>
          <select id="chain-select" class="rounded-full border border-line/60 bg-pine/70 px-3 py-2 text-sm text-ink">
            <option>Loading</option>
          </select>
        </div>
      </div>
    </div>

    <main class="mx-auto w-full max-w-6xl px-6 py-10">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-semibold">Application status</h2>
          <p class="mt-2 text-sm text-ink/60">
            Live chain health pulled directly from wallet core.
          </p>
        </div>
        <div class="flex items-center gap-2 text-xs text-ink/60">
          <span class="h-2 w-2 animate-pulse rounded-full bg-emerald-500"></span>
          <span>Live updates</span>
        </div>
      </div>

      <div class="mt-8 grid gap-6 lg:grid-cols-2">
        <section class="rounded-3xl border border-line/60 bg-pine/85 p-6 shadow-[0_20px_60px_-45px_rgba(0,0,0,0.9)]">
          <div class="flex items-center justify-between border-b border-line/40 pb-4">
            <h3 class="text-xl font-semibold">Blockbook</h3>
            <span id="sync-badge" class="rounded-full border border-emerald-400/40 bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200">
              Syncing
            </span>
          </div>
          <dl class="mt-4 grid gap-3 text-sm">
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Coin</dt>
              <dd id="bb-coin" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Host</dt>
              <dd id="bb-host" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Version / Commit / Build</dt>
              <dd id="bb-version" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Synchronized</dt>
              <dd id="bb-sync" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Last Block</dt>
              <dd id="bb-height" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Last Block Update</dt>
              <dd id="bb-block-time" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Mempool In Sync</dt>
              <dd id="bb-mempool-sync" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Last Mempool Update</dt>
              <dd id="bb-mempool-time" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Transactions in Mempool</dt>
              <dd id="bb-mempool-size" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">DB Size</dt>
              <dd id="bb-db-size" class="font-semibold">-</dd>
            </div>
          </dl>
          <p class="mt-6 text-xs text-ink/40">
            Neko Explorer - blockchain indexer. Do not use for any other purpose.
          </p>
        </section>

        <section class="rounded-3xl border border-line/60 bg-pine/85 p-6 shadow-[0_20px_60px_-45px_rgba(0,0,0,0.9)]">
          <div class="flex items-center justify-between border-b border-line/40 pb-4">
            <h3 class="text-xl font-semibold">Backend</h3>
            <div class="flex items-center gap-2">
              <span id="backend-status" class="rounded-full border border-amber-300/40 bg-amber-400/20 px-3 py-1 text-xs font-semibold text-amber-200">
                Syncing
              </span>
              <span id="backend-source" class="rounded-full bg-line/40 px-3 py-1 text-xs font-semibold text-ink/70">
              -
              </span>
            </div>
          </div>
          <dl class="mt-4 grid gap-3 text-sm">
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Chain</dt>
              <dd id="be-chain" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Version</dt>
              <dd id="be-version" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Subversion</dt>
              <dd id="be-subversion" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Protocol Version</dt>
              <dd id="be-protocol" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Last Block</dt>
              <dd id="be-blocks" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Last Block Update</dt>
              <dd id="be-block-time" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Best Block Hash</dt>
              <dd id="be-best-hash" class="break-all text-right font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Difficulty</dt>
              <dd id="be-difficulty" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Time Offset</dt>
              <dd id="be-timeoffset" class="font-semibold">-</dd>
            </div>
            <div class="flex justify-between border-b border-line/40 pb-2">
              <dt class="text-ink/60">Size On Disk</dt>
              <dd id="be-size" class="font-semibold">-</dd>
            </div>
          </dl>
        </section>
      </div>

      <section class="mt-6 rounded-3xl border border-line/60 bg-pine/85 p-6 shadow-[0_20px_60px_-45px_rgba(0,0,0,0.9)]">
        <div class="flex flex-wrap items-center justify-between gap-2 border-b border-line/40 pb-4">
          <h3 class="text-xl font-semibold">Masternodes</h3>
          <span id="mn-supported" class="rounded-full bg-line/40 px-3 py-1 text-xs font-semibold text-ink/70">
            -
          </span>
        </div>
        <div class="mt-4 grid gap-4 md:grid-cols-3">
          <div class="rounded-2xl border border-line/40 bg-haze/40 p-4">
            <p class="text-xs uppercase tracking-[0.2em] text-ink/50">Total</p>
            <p id="mn-total" class="mt-2 text-lg font-semibold">-</p>
          </div>
          <div class="rounded-2xl border border-line/40 bg-haze/40 p-4">
            <p class="text-xs uppercase tracking-[0.2em] text-ink/50">Enabled</p>
            <p id="mn-enabled" class="mt-2 text-lg font-semibold">-</p>
          </div>
          <div class="rounded-2xl border border-line/40 bg-haze/40 p-4">
            <p class="text-xs uppercase tracking-[0.2em] text-ink/50">Sample</p>
            <div id="mn-list" class="mt-2 text-xs text-ink/60"></div>
          </div>
        </div>
      </section>

      <section class="mt-6 rounded-3xl border border-line/60 bg-pine/85 p-6 shadow-[0_20px_60px_-45px_rgba(0,0,0,0.9)]">
        <div class="flex flex-wrap items-center justify-between gap-2 border-b border-line/40 pb-4">
          <h3 class="text-xl font-semibold">Nodes</h3>
          <span id="node-summary" class="rounded-full bg-line/40 px-3 py-1 text-xs font-semibold text-ink/70">
            -
          </span>
        </div>
        <div class="mt-4 grid gap-4 md:grid-cols-3">
          <div class="rounded-2xl border border-line/40 bg-haze/40 p-4">
            <p class="text-xs uppercase tracking-[0.2em] text-ink/50">Online</p>
            <p id="node-online" class="mt-2 text-lg font-semibold">-</p>
          </div>
          <div class="rounded-2xl border border-line/40 bg-haze/40 p-4">
            <p class="text-xs uppercase tracking-[0.2em] text-ink/50">Syncing</p>
            <p id="node-syncing" class="mt-2 text-lg font-semibold">-</p>
          </div>
          <div class="rounded-2xl border border-line/40 bg-haze/40 p-4">
            <p class="text-xs uppercase tracking-[0.2em] text-ink/50">Offline</p>
            <p id="node-offline" class="mt-2 text-lg font-semibold">-</p>
          </div>
        </div>
        <div id="node-list" class="mt-4 grid gap-2 text-xs text-ink/60"></div>
      </section>
    </main>

    <script>
      const chainSelect = document.getElementById("chain-select");
      const searchInput = document.getElementById("search-input");
      const searchBtn = document.getElementById("search-btn");
      const syncBadge = document.getElementById("sync-badge");

      const fields = {
        bbCoin: document.getElementById("bb-coin"),
        bbHost: document.getElementById("bb-host"),
        bbVersion: document.getElementById("bb-version"),
        bbSync: document.getElementById("bb-sync"),
        bbHeight: document.getElementById("bb-height"),
        bbBlockTime: document.getElementById("bb-block-time"),
        bbMempoolSync: document.getElementById("bb-mempool-sync"),
        bbMempoolTime: document.getElementById("bb-mempool-time"),
        bbMempoolSize: document.getElementById("bb-mempool-size"),
        bbDbSize: document.getElementById("bb-db-size"),
        beChain: document.getElementById("be-chain"),
        beVersion: document.getElementById("be-version"),
        beSubversion: document.getElementById("be-subversion"),
        beProtocol: document.getElementById("be-protocol"),
        beBlocks: document.getElementById("be-blocks"),
        beBlockTime: document.getElementById("be-block-time"),
        beBestHash: document.getElementById("be-best-hash"),
        beDifficulty: document.getElementById("be-difficulty"),
        beTimeOffset: document.getElementById("be-timeoffset"),
        beSize: document.getElementById("be-size"),
        backendSource: document.getElementById("backend-source"),
        backendStatus: document.getElementById("backend-status"),
        mnSupported: document.getElementById("mn-supported"),
        mnTotal: document.getElementById("mn-total"),
        mnEnabled: document.getElementById("mn-enabled"),
        mnList: document.getElementById("mn-list"),
        nodeSummary: document.getElementById("node-summary"),
        nodeOnline: document.getElementById("node-online"),
        nodeSyncing: document.getElementById("node-syncing"),
        nodeOffline: document.getElementById("node-offline"),
        nodeList: document.getElementById("node-list")
      };

      function timeAgo(iso) {
        if (!iso) return "-";
        const diff = Date.now() - new Date(iso).getTime();
        if (Number.isNaN(diff)) return "-";
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        if (days > 0) return `${days} day${days === 1 ? "" : "s"} ago`;
        if (hours > 0) return `${hours} hour${hours === 1 ? "" : "s"} ago`;
        if (minutes > 0) return `${minutes} min${minutes === 1 ? "" : "s"} ago`;
        return `${seconds} sec${seconds === 1 ? "" : "s"} ago`;
      }

      function formatNumber(value) {
        if (value === null || value === undefined) return "-";
        return Number(value).toLocaleString();
      }

      function formatBytes(bytes) {
        const value = Number(bytes);
        if (!value) return "0";
        const units = ["B", "KB", "MB", "GB", "TB"];
        let idx = 0;
        let temp = value;
        while (temp >= 1024 && idx < units.length - 1) {
          temp /= 1024;
          idx += 1;
        }
        return `${temp.toFixed(2)} ${units[idx]}`;
      }

      async function loadChains() {
        const res = await fetch("/api/v1/chains");
        const data = await res.json();
        if (!data.ok) return;
        chainSelect.innerHTML = data.chains
          .map((chain) => `<option value="${chain.id}">${chain.name}</option>`)
          .join("");
      }

      async function loadStatus() {
        const chain = chainSelect.value;
        if (!chain) return;
        const res = await fetch(`/api/v1/${encodeURIComponent(chain)}`);
        const data = await res.json();
        const ok = data.ok !== false;

        fields.bbCoin.textContent = data.blockbook.coin || "-";
        fields.bbHost.textContent = data.blockbook.host || "-";
        fields.bbVersion.textContent = `${data.blockbook.version || "-"} / ${data.blockbook.gitCommit || "-"} / ${data.blockbook.buildTime || "-"}`;
        fields.bbSync.textContent = data.blockbook.inSync ? "TRUE" : "FALSE";
        fields.bbHeight.textContent = formatNumber(data.blockbook.bestHeight);
        fields.bbBlockTime.textContent = timeAgo(data.blockbook.lastBlockTime);
        fields.bbMempoolSync.textContent = data.blockbook.inSyncMempool ? "TRUE" : "FALSE";
        fields.bbMempoolTime.textContent = timeAgo(data.blockbook.lastMempoolTime);
        fields.bbMempoolSize.textContent = formatNumber(data.blockbook.mempoolSize);
        fields.bbDbSize.textContent = formatBytes(data.blockbook.dbSize);

        fields.beChain.textContent = data.backend.chain || "-";
        fields.beVersion.textContent = data.backend.version || "-";
        fields.beSubversion.textContent = data.backend.subversion || "-";
        fields.beProtocol.textContent = data.backend.protocolVersion || "-";
        fields.beBlocks.textContent = formatNumber(data.backend.blocks);
        fields.beBlockTime.textContent = timeAgo(data.backend.lastBlockTime);
        fields.beBestHash.textContent = data.backend.bestBlockHash || "-";
        fields.beDifficulty.textContent = data.backend.difficulty || "-";
        fields.beTimeOffset.textContent = formatNumber(data.backend.timeOffset);
        fields.beSize.textContent = formatBytes(data.backend.sizeOnDisk);
        fields.backendSource.textContent = data.backend.source || "RPC";

        if (data.masternodes?.supported) {
          fields.mnSupported.textContent = "Supported";
          fields.mnTotal.textContent = formatNumber(data.masternodes.total ?? 0);
          fields.mnEnabled.textContent = formatNumber(data.masternodes.enabled ?? data.masternodes.total ?? 0);
          const sample = (data.masternodes.list ?? []).slice(0, 3).map((entry) => {
            if (entry.info) {
              return `<div class="truncate">${entry.key}: ${entry.info}</div>`;
            }
            return `<div class="truncate">${JSON.stringify(entry)}</div>`;
          });
          fields.mnList.innerHTML = sample.join("") || "<div class='text-ink/40'>No sample data</div>";
        } else {
          fields.mnSupported.textContent = "Not available";
          fields.mnTotal.textContent = "-";
          fields.mnEnabled.textContent = "-";
          fields.mnList.innerHTML = "<div class='text-ink/40'>Unsupported</div>";
        }

        if (!ok || data.blockbook.status === "offline") {
          syncBadge.textContent = "Offline";
          syncBadge.className = "rounded-full border border-rose-400/40 bg-rose-500/20 px-3 py-1 text-xs font-semibold text-rose-200";
        } else if (data.blockbook.inSync) {
          syncBadge.textContent = "Synchronized";
          syncBadge.className = "rounded-full border border-emerald-400/40 bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200";
        } else {
          syncBadge.textContent = "Syncing";
          syncBadge.className = "rounded-full border border-amber-300/40 bg-amber-400/20 px-3 py-1 text-xs font-semibold text-amber-200";
        }

        if (!ok || data.backend.status === "offline") {
          fields.backendStatus.textContent = "Offline";
          fields.backendStatus.className = "rounded-full border border-rose-400/40 bg-rose-500/20 px-3 py-1 text-xs font-semibold text-rose-200";
        } else if (data.backend.status === "syncing") {
          fields.backendStatus.textContent = "Syncing";
          fields.backendStatus.className = "rounded-full border border-amber-300/40 bg-amber-400/20 px-3 py-1 text-xs font-semibold text-amber-200";
        } else {
          fields.backendStatus.textContent = "Synchronized";
          fields.backendStatus.className = "rounded-full border border-emerald-400/40 bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200";
        }

        const nodes = data.nodes ?? { total: 0, online: 0, syncing: 0, offline: 0, list: [] };
        fields.nodeSummary.textContent = `${nodes.total || 0} nodes`;
        fields.nodeOnline.textContent = formatNumber(nodes.online ?? 0);
        fields.nodeSyncing.textContent = formatNumber(nodes.syncing ?? 0);
        fields.nodeOffline.textContent = formatNumber(nodes.offline ?? 0);
        fields.nodeList.innerHTML = (nodes.list || [])
          .map((node) => {
            const status = node.status ?? "offline";
            const badge =
              status === "online"
                ? "border-emerald-400/40 bg-emerald-500/20 text-emerald-200"
                : status === "syncing"
                ? "border-amber-300/40 bg-amber-400/20 text-amber-200"
                : "border-rose-400/40 bg-rose-500/20 text-rose-200";
            const height = node.height ?? "-";
            return `
              <div class="flex items-center justify-between rounded-2xl border border-line/40 bg-haze/30 px-3 py-2">
                <span class="font-semibold">${node.id}</span>
                <span class="text-xs text-ink/50">Height ${height}</span>
                <span class="rounded-full border px-2 py-1 text-xs ${badge}">${status}</span>
              </div>
            `;
          })
          .join("");
      }

      function runSearch() {
        const chain = chainSelect.value;
        const query = searchInput.value.trim();
        if (!query || !chain) return;
        if (/^\d+$/.test(query)) {
          window.location.href = `/block/${query}?chain=${encodeURIComponent(chain)}`;
          return;
        }
        if (/^[0-9a-fA-F]{64}$/.test(query)) {
          window.location.href = `/tx/${query}?chain=${encodeURIComponent(chain)}`;
          return;
        }
        window.location.href = `/address/${query}?chain=${encodeURIComponent(chain)}`;
      }

      searchBtn.addEventListener("click", runSearch);
      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") runSearch();
      });

      chainSelect.addEventListener("change", () => {
        loadStatus();
      });

      (async () => {
        await loadChains();
        await loadStatus();
        setInterval(loadStatus, 8000);
      })();
    </script>
  </body>
</html>
