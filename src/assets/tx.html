<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neko Blockbook - Transaction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Sora", "ui-sans-serif", "system-ui"]
            },
            colors: {
              ink: "#e6edf3",
              haze: "#0b0f14",
              pine: "#111a26",
              line: "#233246",
              mint: "#6ef2c7",
              amber: "#f5c07a",
              glow: "#7dc4ff"
            }
          }
        }
      };
    </script>
  </head>
  <body class="min-h-screen bg-haze text-ink bg-[radial-gradient(ellipse_at_top,_#1b2736_0%,_#0b0f14_55%,_#090d12_100%)]">
    <div class="border-b border-line/60 bg-pine/80 backdrop-blur">
      <div class="mx-auto flex w-full max-w-6xl items-center gap-4 px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-full bg-gradient-to-br from-mint via-glow to-amber shadow-[0_0_24px_rgba(124,196,255,0.35)]"></div>
          <div>
            <p class="text-sm uppercase tracking-[0.3em] text-ink/60">Neko</p>
            <h1 class="text-lg font-semibold">Blockbook</h1>
          </div>
        </div>
        <nav class="ml-6 hidden items-center gap-6 text-sm font-semibold text-ink/70 md:flex">
          <a href="/explorer" class="transition hover:text-mint">Status</a>
          <a href="/block/0" class="transition hover:text-mint">Blocks</a>
        </nav>
        <div class="ml-auto flex flex-1 items-center gap-3">
          <div class="flex w-full items-center rounded-full border border-line/60 bg-pine/70 px-3 py-2 shadow-[0_16px_40px_-30px_rgba(0,0,0,0.9)]">
            <input
              id="search-input"
              class="w-full bg-transparent text-sm text-ink outline-none placeholder:text-ink/40"
              placeholder="Search block, transaction, address"
            />
            <button id="search-btn" class="rounded-full bg-mint px-3 py-1 text-xs font-semibold text-haze transition hover:bg-mint/90">
              Go
            </button>
          </div>
          <select id="chain-select" class="rounded-full border border-line/60 bg-pine/70 px-3 py-2 text-sm text-ink">
            <option>Loading</option>
          </select>
        </div>
      </div>
    </div>

    <main class="mx-auto w-full max-w-6xl px-6 py-10">
      <div>
        <h2 class="text-3xl font-semibold">Transaction</h2>
        <p class="mt-2 break-all text-sm text-ink/70" id="txid">-</p>
      </div>

      <section class="mt-8 rounded-3xl border border-line/60 bg-pine/85 p-6 shadow-[0_20px_60px_-45px_rgba(0,0,0,0.9)]">
        <dl class="grid gap-3 text-sm">
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">Mined Time</dt>
            <dd id="tx-time" class="font-semibold">-</dd>
          </div>
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">In Block</dt>
            <dd id="tx-blockhash" class="break-all text-right font-semibold">-</dd>
          </div>
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">In Block Height</dt>
            <dd id="tx-height" class="font-semibold">-</dd>
          </div>
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">Total Input</dt>
            <dd id="tx-input" class="font-semibold">-</dd>
          </div>
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">Total Output</dt>
            <dd id="tx-output" class="font-semibold">-</dd>
          </div>
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">Size</dt>
            <dd id="tx-size" class="font-semibold">-</dd>
          </div>
          <div class="flex justify-between border-b border-line/40 pb-2">
            <dt class="text-ink/60">Fees</dt>
            <dd id="tx-fees" class="font-semibold">-</dd>
          </div>
        </dl>
      </section>

      <section class="mt-8 rounded-3xl border border-line/60 bg-pine/85 p-6 shadow-[0_20px_60px_-45px_rgba(0,0,0,0.9)]">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <h3 class="text-lg font-semibold">Inputs ? Outputs</h3>
          <span id="tx-confirmations" class="text-xs text-ink/60">-</span>
        </div>
        <div class="mt-4 grid gap-4 lg:grid-cols-2">
          <div id="tx-inputs" class="rounded-2xl border border-line/40 bg-haze/40 p-4 text-xs text-ink/70"></div>
          <div id="tx-outputs" class="rounded-2xl border border-line/40 bg-pine/70 p-4 text-xs text-ink/70"></div>
        </div>
      </section>

      <section class="mt-8">
        <div class="flex items-center gap-4 text-sm font-semibold">
          <button id="tab-json" class="rounded-full border border-line/60 bg-pine/90 px-4 py-2 transition hover:border-mint/60">Raw Transaction</button>
          <button id="tab-hex" class="rounded-full border border-line/60 bg-pine/90 px-4 py-2 transition hover:border-mint/60">Raw Transaction Hex</button>
        </div>
        <div id="raw-json" class="mt-4 rounded-2xl bg-black/40 p-4 text-xs text-mint"></div>
        <div id="raw-hex" class="mt-4 hidden rounded-2xl bg-black/40 p-4 text-xs text-mint"></div>
      </section>
    </main>

    <script>
      const chainSelect = document.getElementById("chain-select");
      const searchInput = document.getElementById("search-input");
      const searchBtn = document.getElementById("search-btn");
      const txid = window.location.pathname.split("/").pop();
      const params = new URLSearchParams(window.location.search);
      let selectedChain = params.get("chain") || localStorage.getItem("nekoChain") || "";
      let selectedSymbol = "";
      const symbolByChain = new Map();

      const ui = {
        txid: document.getElementById("txid"),
        time: document.getElementById("tx-time"),
        blockhash: document.getElementById("tx-blockhash"),
        height: document.getElementById("tx-height"),
        input: document.getElementById("tx-input"),
        output: document.getElementById("tx-output"),
        size: document.getElementById("tx-size"),
        fees: document.getElementById("tx-fees"),
        confirmations: document.getElementById("tx-confirmations"),
        inputs: document.getElementById("tx-inputs"),
        outputs: document.getElementById("tx-outputs"),
        rawJson: document.getElementById("raw-json"),
        rawHex: document.getElementById("raw-hex"),
        tabJson: document.getElementById("tab-json"),
        tabHex: document.getElementById("tab-hex")
      };

      function timeAgo(unixSeconds) {
        if (!unixSeconds) return "-";
        const diff = Date.now() - unixSeconds * 1000;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        if (hours > 0) return `${hours} hour${hours === 1 ? "" : "s"} ago`;
        return `${minutes} min${minutes === 1 ? "" : "s"} ago`;
      }

      async function loadChains() {
        const res = await fetch("/api/v1/chains");
        const data = await res.json();
        if (!data.ok) return;
        symbolByChain.clear();
        data.chains.forEach((chain) => symbolByChain.set(chain.id, chain.symbol));
        chainSelect.innerHTML = data.chains
          .map((chain) => `<option value="${chain.id}">${chain.name}</option>`)
          .join("");
        if (selectedChain) {
          chainSelect.value = selectedChain;
        } else if (data.chains[0]) {
          chainSelect.value = data.chains[0].id;
          selectedChain = data.chains[0].id;
        }
        selectedSymbol = symbolByChain.get(chainSelect.value) || "";
      }

      async function loadTx() {
        const chain = chainSelect.value;
        if (!chain) return;
        const res = await fetch(`/api/v1/${encodeURIComponent(chain)}/tx/${txid}`);
        const data = await res.json();
        if (data.ok === false) return;

        ui.txid.textContent = data.txid || txid;
        ui.time.textContent = timeAgo(data.time);
        ui.blockhash.textContent = data.blockhash || "-";
        ui.height.textContent = data.blockheight ?? "-";
        const symbol = selectedSymbol || symbolByChain.get(chainSelect.value) || "COIN";
        ui.input.textContent = `${data.valueIn} ${symbol}`;
        ui.output.textContent = `${data.valueOut} ${symbol}`;
        ui.size.textContent = data.size ?? "-";
        ui.fees.textContent = `${data.fees} ${symbol}`;
        ui.confirmations.textContent = `${data.confirmations ?? 0} confirmations`;

        ui.inputs.innerHTML = data.vin
          .map((input) => {
            if (!input.txid) {
              return `<div class="rounded-xl border border-line/40 bg-pine/70 p-3">No Inputs (Newly Generated Coins)</div>`;
            }
            const addr = input.addresses?.[0] || "Unknown";
            return `
              <div class="rounded-xl border border-line/40 bg-pine/70 p-3">
                <p class="truncate">${addr}</p>
                <p class="text-ink/50">${input.value || ""}</p>
              </div>
            `;
          })
          .join("");

        ui.outputs.innerHTML = data.vout
          .map((output) => {
            const addr = output.scriptPubKey.addresses?.[0] || "Unknown";
            return `
              <div class="rounded-xl border border-line/40 bg-haze/40 p-3">
                <p class="truncate">${addr}</p>
                <p class="text-ink/50">${output.value} ${symbol}</p>
              </div>
            `;
          })
          .join("");

        ui.rawJson.textContent = JSON.stringify(data, null, 2);
        ui.rawHex.textContent = data.hex || "";
      }

      ui.tabJson.addEventListener("click", () => {
        ui.rawJson.classList.remove("hidden");
        ui.rawHex.classList.add("hidden");
      });

      ui.tabHex.addEventListener("click", () => {
        ui.rawHex.classList.remove("hidden");
        ui.rawJson.classList.add("hidden");
      });

      searchBtn.addEventListener("click", () => {
        const query = searchInput.value.trim();
        if (!query) return;
        if (/^\d+$/.test(query)) {
          window.location.href = `/block/${query}?chain=${encodeURIComponent(chainSelect.value)}`;
          return;
        }
        if (/^[0-9a-fA-F]{64}$/.test(query)) {
          window.location.href = `/tx/${query}?chain=${encodeURIComponent(chainSelect.value)}`;
          return;
        }
        window.location.href = `/address/${query}?chain=${encodeURIComponent(chainSelect.value)}`;
      });

      chainSelect.addEventListener("change", () => {
        selectedChain = chainSelect.value;
        selectedSymbol = symbolByChain.get(selectedChain) || "";
        localStorage.setItem("nekoChain", selectedChain);
        const url = new URL(window.location.href);
        url.searchParams.set("chain", selectedChain);
        window.history.replaceState({}, "", url.toString());
        loadTx();
      });

      (async () => {
        await loadChains();
        await loadTx();
      })();
    </script>
  </body>
</html>
